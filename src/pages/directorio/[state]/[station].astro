---
import BaseLayout from '../../../layouts/BaseLayout.astro';
import Breadcrumbs from '../../../components/layout/Breadcrumbs.astro';
import Badge from '../../../components/ui/Badge.astro';
import Button from '../../../components/ui/Button.astro';
import JsonLd from '../../../components/seo/JsonLd.astro';
import { getCollection, render } from 'astro:content';
import states from '../../../data/states.json';

export async function getStaticPaths() {
  const allStations = await getCollection('stations');

  return allStations.map((station) => {
    const stationSlug = station.id.split('/').pop()?.replace('.md', '') || '';

    // Get related stations (same state, excluding current)
    const relatedStations = allStations
      .filter(s => s.data.stateSlug === station.data.stateSlug && s.id !== station.id)
      .slice(0, 5);

    return {
      params: {
        state: station.data.stateSlug,
        station: stationSlug,
      },
      props: { station, relatedStations, allStations },
    };
  });
}

const { station, relatedStations, allStations } = Astro.props;
const { data } = station;
const { Content } = await render(station);

const state = states.find((s) => s.slug === data.stateSlug);
const currentStationSlug = station.id.split('/').pop()?.replace('.md', '') || '';

// Calculate nearby stations by distance
function getDistance(lat1: number, lon1: number, lat2: number, lon2: number): number {
  const R = 6371; // Earth's radius in km
  const dLat = (lat2 - lat1) * Math.PI / 180;
  const dLon = (lon2 - lon1) * Math.PI / 180;
  const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
    Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
    Math.sin(dLon/2) * Math.sin(dLon/2);
  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
  return R * c;
}

// Get nearest stations (from all states)
const nearbyStations = allStations
  .filter(s => s.id !== station.id)
  .map(s => ({
    ...s,
    distance: getDistance(data.latitude, data.longitude, s.data.latitude, s.data.longitude)
  }))
  .sort((a, b) => a.distance - b.distance)
  .slice(0, 3);

const serviceTypeLabels: Record<string, string> = {
  'profesional': 'Profesional',
  'voluntario': 'Voluntario',
  'industrial': 'Industrial',
  'aeroportuario': 'Aeroportuario',
  'proteccion-civil': 'Protección Civil',
};

const serviceLabels: Record<string, string> = {
  'combate-incendios': 'Combate de Incendios',
  'atencion-medica': 'Atención Médica',
  'rescate-vehicular': 'Rescate Vehicular',
  'rescate-acuatico': 'Rescate Acuático',
  'materiales-peligrosos': 'Materiales Peligrosos (Hazmat)',
  'rescate-alturas': 'Rescate en Alturas',
  'proteccion-civil': 'Protección Civil',
  'capacitacion': 'Capacitación',
  'prevencion': 'Prevención',
};

// Google Maps URL
const mapsUrl = `https://www.google.com/maps/search/?api=1&query=${data.latitude},${data.longitude}`;

// Schema.org data
const schemaData = {
  "@context": "https://schema.org",
  "@type": "FireStation",
  "name": data.name,
  "address": {
    "@type": "PostalAddress",
    "streetAddress": data.address,
    "addressLocality": data.city,
    "addressRegion": data.state,
    "postalCode": data.postalCode || "",
    "addressCountry": "MX"
  },
  "geo": {
    "@type": "GeoCoordinates",
    "latitude": data.latitude,
    "longitude": data.longitude
  },
  "telephone": data.phone,
  "openingHoursSpecification": {
    "@type": "OpeningHoursSpecification",
    "dayOfWeek": ["Monday","Tuesday","Wednesday","Thursday","Friday","Saturday","Sunday"],
    "opens": "00:00",
    "closes": "23:59"
  },
  "url": `https://firefighter.com.mx/directorio/${data.stateSlug}/${currentStationSlug}`
};
---

<BaseLayout
  title={data.metaTitle || `${data.name} | Bomberos ${data.city}`}
  description={data.metaDescription || `${data.name} en ${data.city}, ${data.state}. Dirección: ${data.address}. Tel: ${data.phone}. Emergencias: 911.`}
>
  <JsonLd type="FireStation" data={schemaData} />

  <div class="bg-slate-50 min-h-screen">
    <div class="container-custom py-8">
      <Breadcrumbs
        items={[
          { label: 'Directorio', href: '/directorio' },
          { label: state?.name || data.state, href: `/directorio/${data.stateSlug}` },
          { label: data.name },
        ]}
      />

      <!-- Header -->
      <div class="card p-6 md:p-8 mb-6">
        <div class="flex flex-wrap items-start justify-between gap-4 mb-6">
          <div>
            <div class="flex flex-wrap gap-2 mb-3">
              <Badge variant={data.status === 'activa' ? 'success' : 'slate'}>
                {data.status === 'activa' ? 'Activa' : data.status}
              </Badge>
              <Badge variant="fire">
                {serviceTypeLabels[data.serviceType] || data.serviceType}
              </Badge>
              {data.verified && (
                <Badge variant="info">Verificada</Badge>
              )}
            </div>
            <h1 class="text-2xl md:text-3xl font-display font-bold text-slate-800 mb-2">
              {data.name}
            </h1>
            <p class="text-fire-600 font-medium">
              {data.municipality}, {data.city} — {data.state}
            </p>
          </div>

          <div class="flex gap-3">
            <a
              href={`tel:${data.phone}`}
              class="btn btn-primary"
            >
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"></path>
              </svg>
              Llamar
            </a>
            <a
              href={mapsUrl}
              target="_blank"
              rel="noopener noreferrer"
              class="btn btn-outline"
            >
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
              </svg>
              Cómo llegar
            </a>
          </div>
        </div>

        <div class="flex items-start gap-2 text-slate-600">
          <svg class="w-5 h-5 mt-0.5 flex-shrink-0 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
          </svg>
          <span>{data.address}{data.neighborhood ? `, ${data.neighborhood}` : ''}{data.postalCode ? `, C.P. ${data.postalCode}` : ''}</span>
        </div>
      </div>

      <div class="grid lg:grid-cols-3 gap-6">
        <!-- Main Content -->
        <div class="lg:col-span-2 space-y-6">
          <!-- Map Placeholder -->
          <div class="card overflow-hidden">
            <div class="aspect-video bg-slate-200 relative">
              <iframe
                src={`https://www.openstreetmap.org/export/embed.html?bbox=${data.longitude-0.01}%2C${data.latitude-0.01}%2C${data.longitude+0.01}%2C${data.latitude+0.01}&layer=mapnik&marker=${data.latitude}%2C${data.longitude}`}
                class="w-full h-full border-0"
                loading="lazy"
                title={`Mapa de ${data.name}`}
              ></iframe>
            </div>
            <div class="p-4 bg-slate-50 flex items-center justify-between">
              <span class="text-sm text-slate-500">
                Coordenadas: {data.latitude.toFixed(4)}, {data.longitude.toFixed(4)}
              </span>
              <a
                href={mapsUrl}
                target="_blank"
                rel="noopener noreferrer"
                class="text-sm text-fire-600 hover:text-fire-700 font-medium"
              >
                Abrir en Google Maps →
              </a>
            </div>
          </div>

          <!-- Services -->
          <div class="card p-6">
            <h2 class="text-xl font-display font-semibold text-slate-800 mb-4">
              Servicios
            </h2>
            <div class="grid sm:grid-cols-2 gap-3">
              {data.services.map((service) => (
                <div class="flex items-center gap-3 p-3 bg-slate-50 rounded-lg">
                  <div class="w-8 h-8 bg-fire-100 rounded-lg flex items-center justify-center">
                    <svg class="w-4 h-4 text-fire-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                    </svg>
                  </div>
                  <span class="text-slate-700 font-medium text-sm">
                    {serviceLabels[service] || service}
                  </span>
                </div>
              ))}
            </div>
          </div>

          <!-- Content from Markdown - Enhanced Design -->
          <div class="station-content">
            <Content />
          </div>
        </div>

        <!-- Sidebar -->
        <div class="space-y-6">
          <!-- Contact Info -->
          <div class="card p-6">
            <h2 class="text-lg font-display font-semibold text-slate-800 mb-4">
              Contacto
            </h2>
            <div class="space-y-4">
              <div>
                <div class="text-sm text-slate-500 mb-1">Teléfono principal</div>
                <a href={`tel:${data.phone}`} class="text-fire-600 hover:text-fire-700 font-medium">
                  {data.phone}
                </a>
              </div>

              {data.adminPhone && (
                <div>
                  <div class="text-sm text-slate-500 mb-1">Teléfono administrativo</div>
                  <a href={`tel:${data.adminPhone}`} class="text-slate-700 hover:text-fire-600">
                    {data.adminPhone}
                  </a>
                </div>
              )}

              <div>
                <div class="text-sm text-slate-500 mb-1">Emergencias</div>
                <a href="tel:911" class="text-2xl font-display font-bold text-gold-500 hover:text-gold-600">
                  911
                </a>
              </div>

              {data.email && (
                <div>
                  <div class="text-sm text-slate-500 mb-1">Email</div>
                  <a href={`mailto:${data.email}`} class="text-slate-700 hover:text-fire-600 break-all">
                    {data.email}
                  </a>
                </div>
              )}

              {data.website && (
                <div>
                  <div class="text-sm text-slate-500 mb-1">Sitio web</div>
                  <a href={data.website} target="_blank" rel="noopener noreferrer" class="text-fire-600 hover:text-fire-700">
                    Visitar sitio oficial →
                  </a>
                </div>
              )}
            </div>
          </div>

          <!-- Station Info -->
          <div class="card p-6">
            <h2 class="text-lg font-display font-semibold text-slate-800 mb-4">
              Información
            </h2>
            <dl class="space-y-3">
              <div class="flex justify-between">
                <dt class="text-slate-500">Horario</dt>
                <dd class="font-medium text-slate-800">{data.operatingHours}</dd>
              </div>

              {data.yearEstablished && (
                <div class="flex justify-between">
                  <dt class="text-slate-500">Fundación</dt>
                  <dd class="font-medium text-slate-800">{data.yearEstablished}</dd>
                </div>
              )}

              {data.totalPersonnel && (
                <div class="flex justify-between">
                  <dt class="text-slate-500">Personal</dt>
                  <dd class="font-medium text-slate-800">{data.totalPersonnel} personas</dd>
                </div>
              )}

              {data.equipment && (
                <>
                  {data.equipment.fireTrucks > 0 && (
                    <div class="flex justify-between">
                      <dt class="text-slate-500">Camiones</dt>
                      <dd class="font-medium text-slate-800">{data.equipment.fireTrucks}</dd>
                    </div>
                  )}
                  {data.equipment.ambulances > 0 && (
                    <div class="flex justify-between">
                      <dt class="text-slate-500">Ambulancias</dt>
                      <dd class="font-medium text-slate-800">{data.equipment.ambulances}</dd>
                    </div>
                  )}
                </>
              )}
            </dl>
          </div>

          <!-- Nearby Stations -->
          {nearbyStations.length > 0 && (
            <div class="card p-6">
              <h2 class="text-lg font-display font-semibold text-slate-800 mb-4">
                Estaciones Cercanas
              </h2>
              <div class="space-y-3">
                {nearbyStations.map((nearbyStation) => {
                  const slug = nearbyStation.id.split('/').pop()?.replace('.md', '');
                  return (
                    <a
                      href={`/directorio/${nearbyStation.data.stateSlug}/${slug}`}
                      class="block p-3 bg-slate-50 rounded-lg hover:bg-fire-50 hover:border-fire-200 border border-transparent transition-all group"
                    >
                      <div class="font-medium text-slate-800 group-hover:text-fire-600 text-sm mb-1">
                        {nearbyStation.data.name}
                      </div>
                      <div class="flex items-center justify-between text-xs text-slate-500">
                        <span>{nearbyStation.data.municipality}</span>
                        <span class="text-fire-600 font-medium">
                          ~{nearbyStation.distance.toFixed(1)} km
                        </span>
                      </div>
                    </a>
                  );
                })}
              </div>
            </div>
          )}

          <!-- Other Stations in State -->
          {relatedStations.length > 0 && (
            <div class="card p-6">
              <h2 class="text-lg font-display font-semibold text-slate-800 mb-4">
                Más en {state?.name || data.state}
              </h2>
              <div class="space-y-2">
                {relatedStations.map((relStation) => {
                  const slug = relStation.id.split('/').pop()?.replace('.md', '');
                  return (
                    <a
                      href={`/directorio/${relStation.data.stateSlug}/${slug}`}
                      class="flex items-center gap-2 p-2 rounded-lg hover:bg-slate-50 transition-colors group"
                    >
                      <div class="w-6 h-6 bg-fire-100 rounded flex items-center justify-center flex-shrink-0">
                        <svg class="w-3 h-3 text-fire-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 18.657A8 8 0 016.343 7.343S7 9 9 10c0-2 .5-5 2.986-7C14 5 16.09 5.777 17.656 7.343A7.975 7.975 0 0120 13a7.975 7.975 0 01-2.343 5.657z"></path>
                        </svg>
                      </div>
                      <span class="text-sm text-slate-700 group-hover:text-fire-600 truncate">
                        {relStation.data.name}
                      </span>
                    </a>
                  );
                })}
              </div>
              <a
                href={`/directorio/${data.stateSlug}`}
                class="block mt-4 text-center text-sm text-fire-600 hover:text-fire-700 font-medium"
              >
                Ver todas en {state?.name || data.state} →
              </a>
            </div>
          )}

          <!-- Emergency CTA -->
          <div class="bg-fire-600 rounded-xl p-6 text-center text-white">
            <h3 class="font-display font-semibold mb-2">¿Emergencia?</h3>
            <p class="text-fire-100 text-sm mb-4">No esperes, llama inmediatamente</p>
            <a
              href="tel:911"
              class="block w-full py-3 bg-white text-fire-600 font-bold rounded-lg hover:bg-fire-50 transition-colors"
            >
              Llamar al 911
            </a>
          </div>
        </div>
      </div>
    </div>
  </div>
</BaseLayout>

<style>
  /* Station Content - Enhanced Design System */
  .station-content {
    @apply space-y-6;
  }

  /* Main Section Cards (H2) */
  .station-content :global(h2) {
    @apply relative flex items-center gap-3 text-xl font-display font-bold text-white
           bg-gradient-to-r from-fire-600 to-fire-500
           px-6 py-4 rounded-t-xl mt-8 mb-0;
  }

  .station-content :global(h2)::before {
    content: '';
    @apply w-8 h-8 rounded-lg bg-white/20 flex items-center justify-center;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='white' stroke-width='2'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' d='M13 10V3L4 14h7v7l9-11h-7z'/%3E%3C/svg%3E");
    background-size: 20px;
    background-position: center;
    background-repeat: no-repeat;
  }

  .station-content :global(h2:first-of-type) {
    @apply mt-0;
  }

  /* Section Content Wrapper */
  .station-content :global(h2 + *) {
    @apply bg-white rounded-b-xl shadow-sm border border-slate-200 border-t-0 p-6;
  }

  .station-content :global(h2 + p),
  .station-content :global(h2 + ul),
  .station-content :global(h2 + ol) {
    @apply bg-white rounded-b-xl shadow-sm border border-slate-200 border-t-0 p-6 text-slate-600;
  }

  /* Subsection Headers (H3) */
  .station-content :global(h3) {
    @apply relative flex items-center gap-2 text-lg font-display font-semibold text-slate-800
           mt-6 mb-4 pb-2 border-b-2 border-fire-200;
  }

  .station-content :global(h3)::before {
    content: '';
    @apply w-6 h-6 rounded bg-fire-100;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%23dc2626' stroke-width='2'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' d='M9 5l7 7-7 7'/%3E%3C/svg%3E");
    background-size: 14px;
    background-position: center;
    background-repeat: no-repeat;
  }

  /* Paragraphs */
  .station-content :global(p) {
    @apply text-slate-600 leading-relaxed mb-4;
  }

  .station-content :global(p strong) {
    @apply text-slate-800 font-semibold;
  }

  /* Lists - Styled as Feature Cards */
  .station-content :global(ul) {
    @apply space-y-2 mb-6 list-none pl-0;
  }

  .station-content :global(ul li) {
    @apply relative flex items-start gap-3 p-3 bg-slate-50 rounded-lg border border-slate-100
           hover:bg-fire-50 hover:border-fire-200 transition-colors;
  }

  .station-content :global(ul li)::before {
    content: '';
    @apply w-5 h-5 rounded bg-fire-500 flex-shrink-0 mt-0.5;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='white' stroke-width='3'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' d='M5 13l4 4L19 7'/%3E%3C/svg%3E");
    background-size: 12px;
    background-position: center;
    background-repeat: no-repeat;
  }

  .station-content :global(ul li strong) {
    @apply text-fire-700 font-semibold;
  }

  /* Ordered Lists */
  .station-content :global(ol) {
    @apply space-y-3 mb-6 list-none pl-0 counter-reset: item;
  }

  .station-content :global(ol li) {
    @apply relative flex items-start gap-4 p-4 bg-gradient-to-r from-slate-50 to-white
           rounded-lg border border-slate-200 counter-increment: item;
  }

  .station-content :global(ol li)::before {
    content: counter(item);
    @apply w-8 h-8 rounded-full bg-fire-600 text-white font-bold text-sm
           flex items-center justify-center flex-shrink-0;
  }

  /* Tables - Professional Data Display */
  .station-content :global(table) {
    @apply w-full border-collapse rounded-xl overflow-hidden shadow-sm mb-6;
  }

  .station-content :global(thead) {
    @apply bg-gradient-to-r from-slate-800 to-slate-700;
  }

  .station-content :global(th) {
    @apply text-white font-display font-semibold text-sm text-left px-4 py-3
           border-b border-slate-600;
  }

  .station-content :global(tbody tr) {
    @apply bg-white border-b border-slate-100 hover:bg-fire-50 transition-colors;
  }

  .station-content :global(tbody tr:last-child) {
    @apply border-b-0;
  }

  .station-content :global(td) {
    @apply px-4 py-3 text-slate-600 text-sm;
  }

  .station-content :global(td:first-child) {
    @apply font-medium text-slate-800;
  }

  .station-content :global(td strong) {
    @apply text-fire-600 font-semibold;
  }

  /* Horizontal Rules as Section Dividers */
  .station-content :global(hr) {
    @apply my-8 border-0 h-px bg-gradient-to-r from-transparent via-slate-300 to-transparent;
  }

  /* Blockquotes as Callouts */
  .station-content :global(blockquote) {
    @apply relative bg-gold-50 border-l-4 border-gold-500 rounded-r-lg p-4 my-6
           italic text-slate-700;
  }

  .station-content :global(blockquote)::before {
    content: '"';
    @apply absolute -top-2 left-2 text-5xl text-gold-300 font-serif leading-none;
  }

  /* Code/Technical Info */
  .station-content :global(code) {
    @apply bg-slate-100 text-fire-600 px-2 py-1 rounded text-sm font-mono;
  }

  /* Emphasis Text */
  .station-content :global(em) {
    @apply text-slate-500 not-italic text-sm;
  }

  /* Links */
  .station-content :global(a) {
    @apply text-fire-600 hover:text-fire-700 underline decoration-fire-200
           hover:decoration-fire-400 transition-colors;
  }

  /* Special formatting for specific section types */
  /* Equipment sections get icons */
  .station-content :global(h3:contains("Equip"))::before,
  .station-content :global(h3:contains("Flota"))::before {
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%23dc2626' stroke-width='2'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' d='M8 7h.01M8 11h.01M8 15h.01M12 7h.01M12 11h.01M12 15h.01M16 7h.01M16 11h.01M16 15h.01M6 3h12a2 2 0 012 2v14a2 2 0 01-2 2H6a2 2 0 01-2-2V5a2 2 0 012-2z'/%3E%3C/svg%3E");
  }

  /* Nested content spacing */
  .station-content :global(h3 + p),
  .station-content :global(h3 + ul),
  .station-content :global(h3 + table) {
    @apply mt-0;
  }

  /* Card wrapper for all content after H2 until next H2 */
  .station-content > :global(*:not(h2)) {
    @apply px-6;
  }

  .station-content > :global(h2 ~ *:not(h2)) {
    @apply bg-white mx-0 -mt-px;
  }

  .station-content > :global(h2 ~ *:not(h2):last-child),
  .station-content > :global(h2 ~ hr + *:not(h2)) {
    @apply rounded-b-xl pb-6 mb-6 shadow-sm border-x border-b border-slate-200;
  }

  /* First element after H2 */
  .station-content > :global(h2 + *) {
    @apply pt-6 border-x border-slate-200;
  }
</style>
