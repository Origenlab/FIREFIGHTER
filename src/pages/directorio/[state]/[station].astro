---
import BaseLayout from '../../../layouts/BaseLayout.astro';
import Breadcrumbs from '../../../components/layout/Breadcrumbs.astro';
import Badge from '../../../components/ui/Badge.astro';
import Button from '../../../components/ui/Button.astro';
import JsonLd from '../../../components/seo/JsonLd.astro';
import { getCollection, render } from 'astro:content';
import states from '../../../data/states.json';

export async function getStaticPaths() {
  const allStations = await getCollection('stations');

  return allStations.map((station) => {
    const stationSlug = station.id.split('/').pop()?.replace('.md', '') || '';

    // Get related stations (same state, excluding current)
    const relatedStations = allStations
      .filter(s => s.data.stateSlug === station.data.stateSlug && s.id !== station.id)
      .slice(0, 5);

    return {
      params: {
        state: station.data.stateSlug,
        station: stationSlug,
      },
      props: { station, relatedStations, allStations },
    };
  });
}

const { station, relatedStations, allStations } = Astro.props;
const { data } = station;
const { Content } = await render(station);

const state = states.find((s) => s.slug === data.stateSlug);
const currentStationSlug = station.id.split('/').pop()?.replace('.md', '') || '';

// Calculate nearby stations by distance
function getDistance(lat1: number, lon1: number, lat2: number, lon2: number): number {
  const R = 6371; // Earth's radius in km
  const dLat = (lat2 - lat1) * Math.PI / 180;
  const dLon = (lon2 - lon1) * Math.PI / 180;
  const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
    Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
    Math.sin(dLon/2) * Math.sin(dLon/2);
  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
  return R * c;
}

// Get nearest stations (from all states)
const nearbyStations = allStations
  .filter(s => s.id !== station.id)
  .map(s => ({
    ...s,
    distance: getDistance(data.latitude, data.longitude, s.data.latitude, s.data.longitude)
  }))
  .sort((a, b) => a.distance - b.distance)
  .slice(0, 3);

const serviceTypeLabels: Record<string, string> = {
  'profesional': 'Profesional',
  'voluntario': 'Voluntario',
  'industrial': 'Industrial',
  'aeroportuario': 'Aeroportuario',
  'proteccion-civil': 'Protección Civil',
};

const serviceLabels: Record<string, string> = {
  'combate-incendios': 'Combate de Incendios',
  'atencion-medica': 'Atención Médica',
  'rescate-vehicular': 'Rescate Vehicular',
  'rescate-acuatico': 'Rescate Acuático',
  'materiales-peligrosos': 'Materiales Peligrosos (Hazmat)',
  'rescate-alturas': 'Rescate en Alturas',
  'proteccion-civil': 'Protección Civil',
  'capacitacion': 'Capacitación',
  'prevencion': 'Prevención',
};

// Google Maps URL
const mapsUrl = `https://www.google.com/maps/search/?api=1&query=${data.latitude},${data.longitude}`;

// Schema.org data
const schemaData = {
  "@context": "https://schema.org",
  "@type": "FireStation",
  "name": data.name,
  "address": {
    "@type": "PostalAddress",
    "streetAddress": data.address,
    "addressLocality": data.city,
    "addressRegion": data.state,
    "postalCode": data.postalCode || "",
    "addressCountry": "MX"
  },
  "geo": {
    "@type": "GeoCoordinates",
    "latitude": data.latitude,
    "longitude": data.longitude
  },
  "telephone": data.phone,
  "openingHoursSpecification": {
    "@type": "OpeningHoursSpecification",
    "dayOfWeek": ["Monday","Tuesday","Wednesday","Thursday","Friday","Saturday","Sunday"],
    "opens": "00:00",
    "closes": "23:59"
  },
  "url": `https://firefighter.com.mx/directorio/${data.stateSlug}/${currentStationSlug}`
};
---

<BaseLayout
  title={data.metaTitle || `${data.name} | Bomberos ${data.city}`}
  description={data.metaDescription || `${data.name} en ${data.city}, ${data.state}. Dirección: ${data.address}. Tel: ${data.phone}. Emergencias: 911.`}
>
  <JsonLd type="FireStation" data={schemaData} />

  <div class="bg-slate-50 min-h-screen">
    <div class="container-custom py-8">
      <Breadcrumbs
        items={[
          { label: 'Directorio', href: '/directorio' },
          { label: state?.name || data.state, href: `/directorio/${data.stateSlug}` },
          { label: data.name },
        ]}
      />

      <!-- Header -->
      <div class="card p-6 md:p-8 mb-6">
        <div class="flex flex-wrap items-start justify-between gap-4 mb-6">
          <div>
            <div class="flex flex-wrap gap-2 mb-3">
              <Badge variant={data.status === 'activa' ? 'success' : 'slate'}>
                {data.status === 'activa' ? 'Activa' : data.status}
              </Badge>
              <Badge variant="fire">
                {serviceTypeLabels[data.serviceType] || data.serviceType}
              </Badge>
              {data.verified && (
                <Badge variant="info">Verificada</Badge>
              )}
            </div>
            <h1 class="text-2xl md:text-3xl font-display font-bold text-slate-800 mb-2">
              {data.name}
            </h1>
            <p class="text-fire-600 font-medium">
              {data.municipality}, {data.city} — {data.state}
            </p>
          </div>

          <div class="flex gap-3">
            <a
              href={`tel:${data.phone}`}
              class="btn btn-primary"
            >
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"></path>
              </svg>
              Llamar
            </a>
            <a
              href={mapsUrl}
              target="_blank"
              rel="noopener noreferrer"
              class="btn btn-outline"
            >
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
              </svg>
              Cómo llegar
            </a>
          </div>
        </div>

        <div class="flex items-start gap-2 text-slate-600">
          <svg class="w-5 h-5 mt-0.5 flex-shrink-0 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
          </svg>
          <span>{data.address}{data.neighborhood ? `, ${data.neighborhood}` : ''}{data.postalCode ? `, C.P. ${data.postalCode}` : ''}</span>
        </div>
      </div>

      <div class="grid lg:grid-cols-3 gap-6">
        <!-- Main Content -->
        <div class="lg:col-span-2 space-y-6">
          <!-- Map Placeholder -->
          <div class="card overflow-hidden">
            <div class="aspect-video bg-slate-200 relative">
              <iframe
                src={`https://www.openstreetmap.org/export/embed.html?bbox=${data.longitude-0.01}%2C${data.latitude-0.01}%2C${data.longitude+0.01}%2C${data.latitude+0.01}&layer=mapnik&marker=${data.latitude}%2C${data.longitude}`}
                class="w-full h-full border-0"
                loading="lazy"
                title={`Mapa de ${data.name}`}
              ></iframe>
            </div>
            <div class="p-4 bg-slate-50 flex items-center justify-between">
              <span class="text-sm text-slate-500">
                Coordenadas: {data.latitude.toFixed(4)}, {data.longitude.toFixed(4)}
              </span>
              <a
                href={mapsUrl}
                target="_blank"
                rel="noopener noreferrer"
                class="text-sm text-fire-600 hover:text-fire-700 font-medium"
              >
                Abrir en Google Maps →
              </a>
            </div>
          </div>

          <!-- Services -->
          <div class="card p-6">
            <h2 class="text-xl font-display font-semibold text-slate-800 mb-4">
              Servicios
            </h2>
            <div class="grid sm:grid-cols-2 gap-3">
              {data.services.map((service) => (
                <div class="flex items-center gap-3 p-3 bg-slate-50 rounded-lg">
                  <div class="w-8 h-8 bg-fire-100 rounded-lg flex items-center justify-center">
                    <svg class="w-4 h-4 text-fire-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                    </svg>
                  </div>
                  <span class="text-slate-700 font-medium text-sm">
                    {serviceLabels[service] || service}
                  </span>
                </div>
              ))}
            </div>
          </div>

          <!-- Content from Markdown -->
          <div class="card p-6">
            <div class="prose prose-slate max-w-none">
              <Content />
            </div>
          </div>
        </div>

        <!-- Sidebar -->
        <div class="space-y-6">
          <!-- Contact Info -->
          <div class="card p-6">
            <h2 class="text-lg font-display font-semibold text-slate-800 mb-4">
              Contacto
            </h2>
            <div class="space-y-4">
              <div>
                <div class="text-sm text-slate-500 mb-1">Teléfono principal</div>
                <a href={`tel:${data.phone}`} class="text-fire-600 hover:text-fire-700 font-medium">
                  {data.phone}
                </a>
              </div>

              {data.adminPhone && (
                <div>
                  <div class="text-sm text-slate-500 mb-1">Teléfono administrativo</div>
                  <a href={`tel:${data.adminPhone}`} class="text-slate-700 hover:text-fire-600">
                    {data.adminPhone}
                  </a>
                </div>
              )}

              <div>
                <div class="text-sm text-slate-500 mb-1">Emergencias</div>
                <a href="tel:911" class="text-2xl font-display font-bold text-gold-500 hover:text-gold-600">
                  911
                </a>
              </div>

              {data.email && (
                <div>
                  <div class="text-sm text-slate-500 mb-1">Email</div>
                  <a href={`mailto:${data.email}`} class="text-slate-700 hover:text-fire-600 break-all">
                    {data.email}
                  </a>
                </div>
              )}

              {data.website && (
                <div>
                  <div class="text-sm text-slate-500 mb-1">Sitio web</div>
                  <a href={data.website} target="_blank" rel="noopener noreferrer" class="text-fire-600 hover:text-fire-700">
                    Visitar sitio oficial →
                  </a>
                </div>
              )}
            </div>
          </div>

          <!-- Station Info -->
          <div class="card p-6">
            <h2 class="text-lg font-display font-semibold text-slate-800 mb-4">
              Información
            </h2>
            <dl class="space-y-3">
              <div class="flex justify-between">
                <dt class="text-slate-500">Horario</dt>
                <dd class="font-medium text-slate-800">{data.operatingHours}</dd>
              </div>

              {data.yearEstablished && (
                <div class="flex justify-between">
                  <dt class="text-slate-500">Fundación</dt>
                  <dd class="font-medium text-slate-800">{data.yearEstablished}</dd>
                </div>
              )}

              {data.totalPersonnel && (
                <div class="flex justify-between">
                  <dt class="text-slate-500">Personal</dt>
                  <dd class="font-medium text-slate-800">{data.totalPersonnel} personas</dd>
                </div>
              )}

              {data.equipment && (
                <>
                  {data.equipment.fireTrucks > 0 && (
                    <div class="flex justify-between">
                      <dt class="text-slate-500">Camiones</dt>
                      <dd class="font-medium text-slate-800">{data.equipment.fireTrucks}</dd>
                    </div>
                  )}
                  {data.equipment.ambulances > 0 && (
                    <div class="flex justify-between">
                      <dt class="text-slate-500">Ambulancias</dt>
                      <dd class="font-medium text-slate-800">{data.equipment.ambulances}</dd>
                    </div>
                  )}
                </>
              )}
            </dl>
          </div>

          <!-- Nearby Stations -->
          {nearbyStations.length > 0 && (
            <div class="card p-6">
              <h2 class="text-lg font-display font-semibold text-slate-800 mb-4">
                Estaciones Cercanas
              </h2>
              <div class="space-y-3">
                {nearbyStations.map((nearbyStation) => {
                  const slug = nearbyStation.id.split('/').pop()?.replace('.md', '');
                  return (
                    <a
                      href={`/directorio/${nearbyStation.data.stateSlug}/${slug}`}
                      class="block p-3 bg-slate-50 rounded-lg hover:bg-fire-50 hover:border-fire-200 border border-transparent transition-all group"
                    >
                      <div class="font-medium text-slate-800 group-hover:text-fire-600 text-sm mb-1">
                        {nearbyStation.data.name}
                      </div>
                      <div class="flex items-center justify-between text-xs text-slate-500">
                        <span>{nearbyStation.data.municipality}</span>
                        <span class="text-fire-600 font-medium">
                          ~{nearbyStation.distance.toFixed(1)} km
                        </span>
                      </div>
                    </a>
                  );
                })}
              </div>
            </div>
          )}

          <!-- Other Stations in State -->
          {relatedStations.length > 0 && (
            <div class="card p-6">
              <h2 class="text-lg font-display font-semibold text-slate-800 mb-4">
                Más en {state?.name || data.state}
              </h2>
              <div class="space-y-2">
                {relatedStations.map((relStation) => {
                  const slug = relStation.id.split('/').pop()?.replace('.md', '');
                  return (
                    <a
                      href={`/directorio/${relStation.data.stateSlug}/${slug}`}
                      class="flex items-center gap-2 p-2 rounded-lg hover:bg-slate-50 transition-colors group"
                    >
                      <div class="w-6 h-6 bg-fire-100 rounded flex items-center justify-center flex-shrink-0">
                        <svg class="w-3 h-3 text-fire-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 18.657A8 8 0 016.343 7.343S7 9 9 10c0-2 .5-5 2.986-7C14 5 16.09 5.777 17.656 7.343A7.975 7.975 0 0120 13a7.975 7.975 0 01-2.343 5.657z"></path>
                        </svg>
                      </div>
                      <span class="text-sm text-slate-700 group-hover:text-fire-600 truncate">
                        {relStation.data.name}
                      </span>
                    </a>
                  );
                })}
              </div>
              <a
                href={`/directorio/${data.stateSlug}`}
                class="block mt-4 text-center text-sm text-fire-600 hover:text-fire-700 font-medium"
              >
                Ver todas en {state?.name || data.state} →
              </a>
            </div>
          )}

          <!-- Emergency CTA -->
          <div class="bg-fire-600 rounded-xl p-6 text-center text-white">
            <h3 class="font-display font-semibold mb-2">¿Emergencia?</h3>
            <p class="text-fire-100 text-sm mb-4">No esperes, llama inmediatamente</p>
            <a
              href="tel:911"
              class="block w-full py-3 bg-white text-fire-600 font-bold rounded-lg hover:bg-fire-50 transition-colors"
            >
              Llamar al 911
            </a>
          </div>
        </div>
      </div>
    </div>
  </div>
</BaseLayout>

<style>
  .prose h2 {
    @apply text-xl font-display font-semibold text-slate-800 mt-6 mb-3;
  }

  .prose h3 {
    @apply text-lg font-display font-semibold text-slate-700 mt-4 mb-2;
  }

  .prose p {
    @apply text-slate-600 mb-4;
  }

  .prose ul {
    @apply list-disc list-inside space-y-1 text-slate-600 mb-4;
  }
</style>
